<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ¼ãƒãƒ£ãƒ«ç·šé¦™èŠ±ç«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Shippori Mincho', serif; background: radial-gradient(circle, #2c3e50, #000000); overflow: hidden; }
        canvas { display: block; }
        .ui-text { text-shadow: 0 0 8px rgba(255, 255, 255, 0.7); }
        .mode-button { transition: all 0.2s ease-in-out; }
        .mode-button:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="text-white">
    <canvas id="sparklerCanvas"></canvas>

    <div id="ui-container" class="absolute inset-0 p-8 pointer-events-none">
        <div id="game-ui" class="hidden">
            <h1 class="text-3xl lg:text-4xl ui-text">ãƒãƒ¼ãƒãƒ£ãƒ«ç·šé¦™èŠ±ç«</h1>
            <div id="star-mode-stats" class="text-left mt-2 hidden">
                <p class="text-2xl ui-text">ã‚¹ã‚³ã‚¢: <span id="score">0</span> / 25</p>
                <p class="text-2xl ui-text mt-1">ã®ã“ã‚Šæ™‚é–“: <span id="timer">0</span></p>
            </div>
        </div>
        <div id="message-screen" class="w-full h-full flex flex-col justify-center items-center text-center">
            <h1 id="message-title" class="text-4xl lg:text-5xl ui-text">ãƒãƒ¼ãƒãƒ£ãƒ«ç·šé¦™èŠ±ç«</h1>
            <div id="mode-selection" class="mt-8 pointer-events-auto">
                <p class="text-xl ui-text mb-4">ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ãã ã•ã„</p>
                <div class="flex flex-col md:flex-row gap-4">
                    <button id="star-mode-button" class="mode-button bg-yellow-500/80 text-white font-bold py-4 px-8 rounded-lg shadow-lg">æ˜Ÿã®ã‹ã‘ã‚‰é›†ã‚</button>
                    <button id="life-mode-button" class="mode-button bg-purple-500/80 text-white font-bold py-4 px-8 rounded-lg shadow-lg">ä¸€ç”Ÿä½“é¨“</button>
                </div>
            </div>
            <p id="message-subtitle" class="hidden text-xl lg:text-2xl ui-text mt-4"></p>
            <div id="comment-area" class="hidden mt-6 p-4 bg-black/50 rounded-lg w-full max-w-md">
                <h2 class="text-xl ui-text text-yellow-300">âœ¨ AIã‹ã‚‰ã®ä¸€è¨€ âœ¨</h2>
                <p id="comment-text" class="text-2xl ui-text mt-2 h-10"></p>
            </div>
        </div>
        <div class="absolute bottom-8 left-0 right-0 flex justify-center">
            <button id="reset-button" class="hidden bg-blue-500/50 hover:bg-blue-400/70 text-white font-bold py-3 px-8 rounded-full text-xl transition-all duration-300 pointer-events-auto">ãƒ¢ãƒ¼ãƒ‰é¸æŠã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // --- åˆæœŸè¨­å®š (å¤‰æ›´ãªã—) ---
        const canvas = document.getElementById('sparklerCanvas'); const ctx = canvas.getContext('2d'); const resetButton = document.getElementById('reset-button'); const gameUI = document.getElementById('game-ui'); const starModeStats = document.getElementById('star-mode-stats'); const scoreUI = document.getElementById('score'); const timerUI = document.getElementById('timer'); const messageScreen = document.getElementById('message-screen'); const messageTitle = document.getElementById('message-title'); const messageSubtitle = document.getElementById('message-subtitle'); const modeSelection = document.getElementById('mode-selection'); const starModeButton = document.getElementById('star-mode-button'); const lifeModeButton = document.getElementById('life-mode-button'); const commentArea = document.getElementById('comment-area'); const commentText = document.getElementById('comment-text');
        let particles = [], starFragments = []; let mouse = { x: window.innerWidth / 2, y: window.innerHeight / 2 }; let lastMouse = { x: mouse.x, y: mouse.y }; let gameState = 'waiting'; let selectedMode = ''; let gameInterval; let score = 0; let timeLeft = 0; const TARGET_SCORE = 25; const GAME_DURATION = 30; let gameTimer = 0; let currentStage = 0; const STAGE_DURATIONS = { BOTAN: 7*60, MATSUBA: 8*60, YANAGI: 7*60 }; const TOTAL_DURATION = STAGE_DURATIONS.BOTAN + STAGE_DURATIONS.MATSUBA + STAGE_DURATIONS.YANAGI;
        const droppedMessages = ["å„šãæ•£ã£ãŸã€ä¿ºã®å¤ã€‚", "ã•ã‚ˆãªã‚‰ã€ã™ã¹ã¦ã®ç·šé¦™èŠ±ç«ã€‚", "ã“ã®æ‰‹ã«æ®‹ã‚‹ã¯ã€ãŸã è™šã—ã•ã®ã¿â€¦ã€‚", "æ‰±ã„ãŒé›‘ï¼", "ã‚‚ã†ã¡ã‚‡ã£ã¨å„ªã—ãã—ã¦ãã‚Œãªã„ï¼Ÿ", "ã›ã£ã‹ã¡ã•ã‚“ã‚ã€‚", "å¤ã®çµ‚ã‚ã‚Šã€æ—©ã™ãå•é¡Œã€‚", "é›†ä¸­åŠ›ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚", "ã€æ‚²å ±ã€‘ãƒ¯ã‚¤ã®å¤ã€çµ‚ã‚ã‚‹ã€‚"]; const timeupMessages = ["æ¥½ã—ã„æ™‚é–“ã¯ã‚ã£ã¨ã„ã†é–“ã€‚", "å¤ã®å¤œã®å¤¢ã€è¦šã‚ã‚‹æ™‚é–“ã€‚", "ã¾ãŸæ¥å¹´ã®å¤ã«ä¼šãŠã†ã€‚", "ã©ã†ã‚„ã‚‰æ™‚é–“é…åˆ†ã‚’é–“é•ãˆãŸã‚ˆã†ã ã€‚", "ã‚¿ã‚¤ãƒ ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚‚ã€å¤ã®å—œã¿ã€‚", "ãŠã£ã¨ã€å¤œãŒæ˜ã‘ã¡ã¾ã£ãŸã€‚"]; const apiErrorMessages = ["AIã‚‚ã€å¤ã®å¤œã¯çœ ã„ã‚‰ã—ã„ã€‚", "ã‚³ãƒ¡ãƒ³ãƒˆã®ç¥ã€é™è‡¨ã›ãšã€‚", "AIãŒä¸€å¥è€ƒãˆã¦ã‚‹é–“ã«ã€å¤ãŒçµ‚ã‚ã£ãŸã€‚", "èŠ±ç«ã®ç…™ã§ã€è¨€è‘‰ãŒã‹ã™ã‚€ã€‚", "å¤ã®å¦–ç²¾ãŒã€é›»æ³¢ã‚’é£Ÿã¹ã¦ã—ã¾ã£ãŸï¼", "é™ã‹ã™ãã¦ã€è¨€è‘‰ã‚‚å¯æ¯ã‚’ãŸã¦ã¦ã„ã‚‹ã€‚", "ãˆãƒ¼ã£ã¨ã€ãªã‚“ã ã£ã‘ï¼Ÿ", "ä»£ã‚ã‚Šã«èšŠã®éŸ³ã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚â€¦ãƒ—ã€œãƒ³ã€‚", "é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚ãŸã¶ã‚“ã€‚"]; const lifeClearMessages = ["ã€é™ã€ã®é“ã®ã€å…è¨±çš†ä¼ã€‚", "ãã®é›†ä¸­åŠ›ã€ã¾ã•ã«è·äººæŠ€ã€‚", "ç·šé¦™èŠ±ç«ã‚‚ã€å›ã«è¦‹å®ˆã‚‰ã‚Œæœ¬æœ›ã ã‚ã†ã€‚", "å¤ã®å¤œã«ã€å°ã•ãªå¥‡è·¡ã‚’è¦‹ãŸã€‚", "å›ã¯ã€ãŸã ã®å‚è¦³è€…ã§ã¯ãªã‹ã£ãŸã€‚", "ãã®ä¸€ç¬ã¯ã€æ°¸é ã«ãªã£ãŸã€‚", "å¤ã®é¢¨ç‰©è©©ã€å®Œå…¨æ”»ç•¥ã€‚", "ãŠã‚ã§ã¨ã†ï¼å›ã¯ã‚‚ã†ã€ã©ã“ã§ã‚‚ç”Ÿãã¦ã„ã‘ã‚‹ã€‚", "å¤ã®å®¿é¡Œã€ä¸€ã¤å®Œäº†ã€‚"];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        resizeCanvas(); window.addEventListener('resize', resizeCanvas);
        function updateMousePosition(e) { const event = e.touches ? e.touches[0] : e; mouse.x = event.clientX; mouse.y = event.clientY; }
        class StarFragment { constructor() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.size = Math.random() * 5 + 5; this.alpha = 0; this.alphaChange = 0.05; } update() { this.alpha += this.alphaChange; if (this.alpha > 1 || this.alpha < 0) this.alphaChange *= -1; } draw() { ctx.save(); ctx.globalAlpha = this.alpha; ctx.fillStyle = '#FFD700'; ctx.shadowBlur = 10; ctx.shadowColor = '#FFD700'; ctx.beginPath(); for (let i = 0; i < 5; i++) { ctx.lineTo(this.x + this.size * Math.cos((18 + i * 72) * Math.PI / 180), this.y + this.size * Math.sin((18 + i * 72) * Math.PI / 180)); ctx.lineTo(this.x + (this.size/2) * Math.cos((54 + i * 72) * Math.PI / 180), this.y + (this.size/2) * Math.sin((54 + i * 72) * Math.PI / 180)); } ctx.closePath(); ctx.fill(); ctx.restore(); } }
        class Particle { constructor(x, y, stage, isFireball = false) { this.x = x; this.y = y; this.stage = stage; this.isFireball = isFireball; this.gravity = 0; if (this.isFireball) { this.size = 6; this.vx = (Math.random() - 0.5) * 2; this.vy = Math.random() * 2; this.gravity = 0.1; this.life = 150; } else { const angle = Math.random() * Math.PI * 2; let speed; switch (this.stage) { case 1: this.size = Math.random() * 2 + 1; speed = Math.random() * 2.5 + 0.5; this.life = Math.random() * 50 + 30; break; case 2: this.size = Math.random() * 1.5 + 0.5; speed = Math.random() * 4 + 2; this.life = Math.random() * 40 + 20; break; case 3: this.size = Math.random() * 1 + 1; speed = Math.random() * 1.5 - 0.75; this.gravity = 0.03; this.life = Math.random() * 80 + 40; break; default: this.size = Math.random() * 2 + 1; speed = Math.random() * 3 + 1; this.life = Math.random() * 50 + 20; break;} this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed; } this.initialLife = this.life; } update() { this.vy += this.gravity; this.x += this.vx; this.y += this.vy; this.life--; if (!this.isFireball) { this.vx *= 0.97; this.vy *= 0.97; } } draw() { ctx.globalAlpha = this.life / this.initialLife; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fillStyle = `hsl(${Math.random() * 10 + 30}, 100%, ${Math.random() * 50 + 50}%)`; ctx.fill(); ctx.globalAlpha = 1.0; } }
        function startGame() { gameState = 'playing'; canvas.style.cursor = 'none'; lastMouse = { x: mouse.x, y: mouse.y }; modeSelection.classList.add('hidden'); if (Tone.context.state !== 'running') Tone.context.resume(); if (selectedMode === 'star') { messageScreen.classList.add('hidden'); gameUI.classList.remove('hidden'); starModeStats.classList.remove('hidden'); score = 0; timeLeft = GAME_DURATION; scoreUI.textContent = score; timerUI.textContent = timeLeft; starFragments = []; for(let i = 0; i < 3; i++) starFragments.push(new StarFragment()); gameInterval = setInterval(() => { timeLeft--; timerUI.textContent = timeLeft; if (timeLeft <= 0) gameOver("timeup"); }, 1000); } else if (selectedMode === 'life') { gameUI.classList.add('hidden'); messageScreen.classList.remove('hidden'); messageSubtitle.classList.remove('hidden'); gameTimer = 0; currentStage = 1; messageTitle.textContent = 'ç¬¬ä¸€æ®µéšï¼šç‰¡ä¸¹'; messageSubtitle.textContent = 'ï¼ˆãã£ã¨ã€å‹•ã‹ã—ã¦ï¼‰'; } }
        function animate() { ctx.fillStyle = 'rgba(0, 0, 0, 0.15)'; ctx.fillRect(0, 0, canvas.width, canvas.height); if (gameState === 'playing') { const dx = mouse.x - lastMouse.x; const dy = mouse.y - lastMouse.y; const distance = Math.sqrt(dx * dx + dy * dy); if (distance > 50) { gameOver("dropped"); } else { let particleStage = selectedMode === 'life' ? currentStage : 0; ctx.beginPath(); ctx.arc(mouse.x, mouse.y, 3, 0, Math.PI * 2); ctx.fillStyle = 'white'; ctx.fill(); for (let i = 0; i < 2; i++) particles.push(new Particle(mouse.x, mouse.y, particleStage)); } lastMouse.x = mouse.x; lastMouse.y = mouse.y; if (selectedMode === 'star') updateStarMode(); else if (selectedMode === 'life') updateLifeMode(); } starFragments.forEach(star => star.draw()); particles.forEach((p, index) => { p.update(); p.draw(); if (p.life < 0) particles.splice(index, 1); }); requestAnimationFrame(animate); }
        function updateStarMode() { starFragments.forEach((star, index) => { star.update(); const distToStar = Math.sqrt(Math.pow(mouse.x - star.x, 2) + Math.pow(mouse.y - star.y, 2)); if (distToStar < star.size + 3) { score++; scoreUI.textContent = score; starFragments.splice(index, 1); starFragments.push(new StarFragment()); new Tone.Synth().toDestination().triggerAttackRelease("C5", "16n"); } }); }
        function updateLifeMode() { gameTimer++; if (gameTimer > TOTAL_DURATION) { gameOver('cleared'); } else if (gameTimer > STAGE_DURATIONS.BOTAN + STAGE_DURATIONS.MATSUBA) { if(currentStage !== 3) { currentStage = 3; messageTitle.textContent = 'ç¬¬ä¸‰æ®µéšï¼šæŸ³'; messageSubtitle.textContent = 'ï¼ˆçµ‚ã‚ã‚Šã¯ã€è¿‘ã„ï¼‰'; } } else if (gameTimer > STAGE_DURATIONS.BOTAN) { if(currentStage !== 2) { currentStage = 2; messageTitle.textContent = 'ç¬¬äºŒæ®µéšï¼šæ¾è‘‰'; messageSubtitle.textContent = 'ï¼ˆã¾ã ã¾ã ã€ã“ã‚Œã‹ã‚‰ï¼‰'; } } }
        
        // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ã§ã™ â˜…â˜…â˜…
        async function generateComment(resultType) {
            commentArea.classList.remove('hidden');
            commentText.textContent = 'ç”Ÿæˆä¸­...';
            
            // Hono APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
            const apiUrl = 'https://gemini-api.banbenjianggui.workers.dev/api/comment';

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Hono APIã«ã¯ `resultType` ã‚’é€ã‚‹
                    body: JSON.stringify({ resultType: resultType })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    const errorMessage = errorData?.message || `APIã‚¨ãƒ©ãƒ¼: ${response.statusText}`;
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                
                if (result.success && result.response) {
                    const text = result.response;
                    commentText.textContent = text.replace(/ã€Œ/g, '').replace(/ã€/g, '').replace(/"/g, '');
                } else {
                    commentText.textContent = apiErrorMessages[Math.floor(Math.random() * apiErrorMessages.length)];
                }
            } catch (error) {
                console.error("Comment generation failed:", error);
                commentText.textContent = apiErrorMessages[Math.floor(Math.random() * apiErrorMessages.length)];
            }
        }
        // â˜…â˜…â˜… ã“ã“ã¾ã§ãŒä¿®æ­£ç®‡æ‰€ã§ã™ â˜…â˜…â˜…
        
        function gameOver(reason) { if(gameState !== 'playing') return; clearInterval(gameInterval); gameState = 'ended'; canvas.style.cursor = 'default'; gameUI.classList.add('hidden'); starModeStats.classList.add('hidden'); messageScreen.classList.remove('hidden'); let commentType = ''; if (reason === "dropped") { particles.push(new Particle(mouse.x, mouse.y, 0, true)); messageTitle.textContent = droppedMessages[Math.floor(Math.random() * droppedMessages.length)]; messageSubtitle.textContent = selectedMode === 'star' ? `ã‚¹ã‚³ã‚¢: ${score}` : ' '; commentType = 'dropped'; } else if (reason === "timeup") {  if (score >= TARGET_SCORE) { messageTitle.textContent = 'ğŸ‰ ã‚¯ãƒªã‚¢ï¼ ğŸ‰'; messageSubtitle.innerHTML = `è¦‹äº‹ã«æ˜Ÿã‚’é›†ã‚ã¾ã—ãŸï¼<br>ã‚¹ã‚³ã‚¢: ${score}`; commentType = 'timeup-clear'; } else { messageTitle.textContent = timeupMessages[Math.floor(Math.random() * timeupMessages.length)]; messageSubtitle.textContent = `ã‚¹ã‚³ã‚¢: ${score} (ã‚ã¨${TARGET_SCORE - score}å€‹ã§ã—ãŸ)`; commentType = 'timeup-fail'; } } else if (reason === "cleared") { const randomIndex = Math.floor(Math.random() * lifeClearMessages.length); messageTitle.textContent = `ğŸ‰ ${lifeClearMessages[randomIndex]} ğŸ‰`; messageSubtitle.textContent = 'ã²ã¨å¤ã®ãã‚‰ã‚ãã€ãã®ç›®ã«ç„¼ãä»˜ã‘ã¦ã€‚'; commentType = 'life-clear'; } generateComment(commentType); messageSubtitle.classList.remove('hidden'); resetButton.classList.remove('hidden'); }
        function resetSimulation() { clearInterval(gameInterval); gameState = 'waiting'; selectedMode = ''; particles = []; starFragments = []; canvas.style.cursor = 'default'; messageScreen.classList.remove('hidden'); modeSelection.classList.remove('hidden'); gameUI.classList.add('hidden'); starModeStats.classList.add('hidden'); resetButton.classList.add('hidden'); commentArea.classList.add('hidden'); messageTitle.textContent = 'ãƒãƒ¼ãƒãƒ£ãƒ«ç·šé¦™èŠ±ç«'; messageSubtitle.classList.add('hidden'); }
        starModeButton.addEventListener('click', () => { selectedMode = 'star'; modeSelection.classList.add('hidden'); messageSubtitle.textContent = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹å§‹'; messageSubtitle.classList.remove('hidden'); });
        lifeModeButton.addEventListener('click', () => { selectedMode = 'life'; modeSelection.classList.add('hidden'); messageSubtitle.textContent = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹å§‹'; messageSubtitle.classList.remove('hidden'); });
        canvas.addEventListener('click', () => { if(gameState === 'waiting' && selectedMode) startGame(); });
        resetButton.addEventListener('click', resetSimulation);
        window.addEventListener('mousemove', updateMousePosition); window.addEventListener('touchmove', updateMousePosition, { passive: false });
        resetSimulation();
        animate();
    </script>
</body>
</html>